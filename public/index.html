<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telegram Bots Manager</title>
    <style>
      body {
        font-family: Arial, sans-serif;
      }

      button {
        cursor: pointer;
      }

      .log-entry {
        margin-bottom: 5px;
      }

      .log-success {
        color: green;
      }

      .log-error {
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>Telegram Bots Manager</h1>
    <button id="reload-config" onclick="reloadConfig()">Reload Config</button>
    <button id="start-all" onclick="startAll()">Start All Bots</button>
    <button id="stop-all" onclick="stopAll()">Stop All Bots</button>

    <div id="applications-list">
      <h2>Applications List</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Telegram Token</th>
            <th>Running</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="applications-tbody"></tbody>
      </table>
    </div>

    <h2>Log History</h2>
    <div id="log-history"></div>

    <script>
      const apiUrl = "http://" + window.location.host; // Replace with your FastAPI server address

      async function fetchData(url, { method = "GET", query = {} } = {}) {
        // Add query parameters to the URL
        const searchParams = new URLSearchParams(query);
        const urlWithQuery = new URL(url);
        urlWithQuery.search = searchParams.toString();

        // Fetch data from the URL with query parameters
        const response = await fetch(urlWithQuery, { method: method });
        const data = await response.json();
        return data;
      }

      function displayLogEntry({ text, status, timestamp } = {}) {
        // Create a new log entry element
        const logEntry = document.createElement("div");
        logEntry.classList.add("log-entry");

        // Add a class based on the status
        if (status === "success") {
          logEntry.classList.add("log-success");
        } else if (status === "error") {
          logEntry.classList.add("log-error");
        } else if (status === "info") {
          logEntry.classList.add("log-info");
        }

        // Convert the timestamp to a readable datetime
        const date = new Date(timestamp * 1000);
        const datetime = date.toISOString();

        // Set the log entry content
        logEntry.textContent = `[${datetime}] ${status.toUpperCase()}: ${text}`;

        const logHistory = document.getElementById("log-history");
        logHistory.appendChild(logEntry);
      }


      function currentTimestamp() {
        return Math.floor(Date.now() / 1000);
      }

      async function fetchAndDisplayLogEntries(since) {
        // Fetch log entries since the current timestamp
        const logsUrl = apiUrl + "/logs";

        const options = since ? {query: { since: since }} : {};
        const logs = (await fetchData(logsUrl, options)).logs;

        // Display the fetched log entries using the displayLogEntry function
        logs.forEach((logEntry) => {
          displayLogEntry(logEntry);
        });
      }

      // Modify the loadApplicationsList function
      async function loadApplicationsList() {
        const applications = await fetchData(`${apiUrl}/list`);
        const tbody = document.getElementById("applications-tbody");

        // Clear the existing table content
        tbody.innerHTML = "";

        // Fill the table with the list of applications
        for (const app of applications.applications) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${app.id}</td>
                    <td>${app.telegram_token}</td>
                    <td>${app.running ? "✅" : "❌"}</td>
                    <td>
                        <button onclick="startApp('${app.id}')">Start</button>
                        <button onclick="stopApp('${app.id}')">Stop</button>
                    </td>
                `;
          tbody.appendChild(tr);
        }
      }

      async function startApp(appId) {
        let ts = currentTimestamp();
        const result = await fetchData(`${apiUrl}/start_app/${appId}`, {
          method: "POST",
        });
        fetchAndDisplayLogEntries(ts);
        loadApplicationsList();
      }

      async function stopApp(appId) {
        let ts = currentTimestamp();
        const result = await fetchData(`${apiUrl}/stop_app/${appId}`, {
          method: "POST",
        });
        fetchAndDisplayLogEntries(ts);
        loadApplicationsList();
      }

      async function reloadConfig() {
        let ts = currentTimestamp();
        const result = await fetchData(`${apiUrl}/reload_config`);
        fetchAndDisplayLogEntries(ts);
        loadApplicationsList();
      }

      async function startAll() {
        let ts = currentTimestamp();
        const result = await fetchData(`${apiUrl}/start_all`);
        fetchAndDisplayLogEntries(ts);
        loadApplicationsList();
      }

      async function stopAll() {
        let ts = currentTimestamp();
        const result = await fetchData(`${apiUrl}/stop_all`);
        fetchAndDisplayLogEntries(ts);
        loadApplicationsList();
      }

      // Call the loadApplicationsList function when the page loads
      loadApplicationsList();
      fetchAndDisplayLogEntries();
      setInterval(loadApplicationsList, 5000)
    </script>
  </body>
</html>
